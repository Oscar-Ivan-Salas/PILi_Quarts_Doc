"""
PILI ChatBot - Proyecto Complejo PMI (Electricidad)
VersiÃ³n: 1.0
MetodologÃ­a: PMI PMBOK 7th Edition

Genera PROJECT CHARTER profesional con:
- KPIs de gestiÃ³n (SPI, CPI, EV, PV, AC)
- Cronograma Gantt (6 fases)
- Registro de Stakeholders
- Matriz RACI
- Registro de Riesgos (Top 5)
- 13 Entregables principales
"""

from datetime import datetime, timedelta
from typing import Dict, List, Optional

class PILIElectricidadProyectoComplejoPMIChatBot:
    def __init__(self):
        self.version = "1.0 - PMI PMBOK 7th"
        self.contador = 1
        
    def procesar(self, mensaje: str, estado: Dict) -> Dict:
        """Procesa el mensaje del usuario y retorna respuesta"""
        
        # Inicializar estado si es necesario
        if not estado:
            estado = {}
        
        etapa = estado.get("etapa", "inicial")
        
        # ============================================
        # ETAPA: Inicial - Bienvenida
        # ============================================
        if etapa == "inicial":
            # Auto-detectar datos del frontend
            cliente_nombre = estado.get("cliente_nombre")
            proyecto_nombre = estado.get("proyecto_nombre")
            presupuesto = estado.get("presupuesto")
            moneda = estado.get("moneda", "USD")
            duracion_meses = estado.get("duracion_meses")
            
            # âœ… FLUJO NORMAL: Preguntar todo paso a paso
            estado["etapa"] = "ubicacion"
            return {'success': True, 'respuesta': f"""Â¡Hola! ğŸ‘‹ Soy **PILI**, tu asistente de proyectos elÃ©ctricos PMI.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**DATOS DETECTADOS DEL FORMULARIO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Cliente: **{cliente_nombre or 'No especificado'}**
âœ… Proyecto: **{proyecto_nombre or 'No especificado'}**
âœ… Presupuesto: **{moneda} {presupuesto:,.2f if presupuesto else 'No especificado'}**
âœ… DuraciÃ³n: **{duracion_meses} meses** if duracion_meses else 'No especificado'

Ahora necesito informaciÃ³n adicional para crear el Project Charter completo.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**UBICACIÃ“N DEL PROYECTO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ **Â¿DÃ³nde se realizarÃ¡ el proyecto?**
_Ejemplo: Lima, PerÃº / ConcepciÃ³n, Chile_""", 'botones': None, 'estado': estado}
        
        # ============================================
                    {
                        "id": "R01",
                        "descripcion": "Retrasos en entrega de equipos importados",
                        "probabilidad": "Media",
                        "impacto": "Alto",
                        "severidad": "Alta",
                        "mitigacion": "Compra anticipada con proveedores alternativos certificados"
                    },
                    {
                        "id": "R02",
                        "descripcion": "Cambios en alcance solicitados por cliente",
                        "probabilidad": "Media",
                        "impacto": "Medio",
                        "severidad": "Media",
                        "mitigacion": "Control de cambios formal con aprobaciÃ³n escrita y ajuste de cronograma"
                    },
                    {
                        "id": "R03",
                        "descripcion": "Condiciones climÃ¡ticas adversas",
                        "probabilidad": "Baja",
                        "impacto": "Medio",
                        "severidad": "Baja",
                        "mitigacion": "PlanificaciÃ³n de actividades crÃ­ticas en temporada seca"
                    }
                ]
                
                # Recursos por defecto
                estado["recursos_humanos"] = ["Project Manager PMI", "Ing. Residente", "Ing. ElÃ©ctrico", "TÃ©cnicos (3)", "Inspector QA"]
                estado["materiales"] = ["Tableros elÃ©ctricos certificados", "Cables THW/THHN", "Protecciones termomagnÃ©ticas", "Sistema de puesta a tierra", "Luminarias LED"]
                
                # âœ… GENERAR PROYECTO DIRECTAMENTE
                simbolo = {'PEN': 'S/', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£'}.get(moneda, '$')
                return {
                    'success': True,
                    'respuesta': f"""ğŸ‰ **PROJECT CHARTER GENERADO AUTOMÃTICAMENTE**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**DATOS DETECTADOS DEL FORMULARIO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… Cliente: **{cliente_nombre}**
âœ… Proyecto: **{proyecto_nombre}**
âœ… Presupuesto: **{simbolo} {presupuesto:,.2f}**
âœ… DuraciÃ³n: **{duracion_meses} meses ({duracion_dias} dÃ­as)**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**PROYECTO COMPLETO GENERADO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

He creado un PROJECT CHARTER profesional con:
â€¢ âœ… KPIs PMI optimizados (SPI: 1.05, CPI: 0.98)
â€¢ âœ… Cronograma Gantt (6 fases, {duracion_dias} dÃ­as)
â€¢ âœ… 3 Stakeholders principales
â€¢ âœ… Top 3 Riesgos identificados
â€¢ âœ… Equipo de 5 roles + Materiales certificados

**KPIs CALCULADOS:**
â€¢ EV: {simbolo}{estado['ev_k']}K | PV: {simbolo}{estado['pv_k']}K | AC: {simbolo}{estado['ac_k']}K

âœ… **Documento listo para generar**

Haz clic en "Finalizar" para ver la vista previa y generar el PROJECT CHARTER en Word/PDF.""",
                    'botones': None,
                    'estado': estado,
                    'datos_generados': self._generar_proyecto(estado)['datos_generados']
                }
            
            # Modo manual si faltan datos
            if cliente_nombre and proyecto_nombre and presupuesto:
                estado["etapa"] = "ubicacion"
                simbolo = {'PEN': 'S/', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£'}.get(moneda, '$')
                return {'success': True, 'respuesta': f"""Â¡Hola! ğŸ‘‹ **PILI** - Proyecto Complejo PMI

ğŸ“‹ **GENERACIÃ“N DE PROJECT CHARTER PROFESIONAL**
_SegÃºn metodologÃ­a PMI PMBOK 7th Edition_

He detectado los siguientes datos:
âœ… Cliente: **{cliente_nombre}**
âœ… Proyecto: **{proyecto_nombre}**
âœ… Presupuesto: **{simbolo} {presupuesto:,.2f}**
âœ… Moneda: **{moneda}**

Vamos a crear un PROJECT CHARTER completo con:
â€¢ KPIs de gestiÃ³n (SPI, CPI, EV, PV, AC)
â€¢ Cronograma Gantt (6 fases)
â€¢ Registro de Stakeholders
â€¢ Matriz RACI
â€¢ Registro de Riesgos (Top 5)
â€¢ 13 Entregables principales

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**INFORMACIÃ“N TÃ‰CNICA DEL PROYECTO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ **Â¿UbicaciÃ³n exacta del proyecto?**
_Ejemplo: Av. Principal 123, San Isidro, Lima_""", 'botones': None, 'estado': estado}
            else:
                estado["etapa"] = "ubicacion"
                return {'success': True, 'respuesta': """Â¡Hola! ğŸ‘‹ **PILI** - Proyecto Complejo PMI

ğŸ“‹ **GENERACIÃ“N DE PROJECT CHARTER PROFESIONAL**

Necesito informaciÃ³n bÃ¡sica del proyecto.

ğŸ“ **Â¿UbicaciÃ³n exacta del proyecto?**""", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: UbicaciÃ³n
        # ============================================
        elif etapa == "ubicacion":
            estado["ubicacion"] = mensaje
            estado["etapa"] = "area"
            return {'success': True, 'respuesta': f"""âœ… UbicaciÃ³n: **{mensaje}**

ğŸ“ **Â¿Ãrea total del proyecto (mÂ²)?**
_Ejemplo: 5000_""", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: Ãrea
        # ============================================
        elif etapa == "area":
            try:
                area = float(mensaje.replace(',', ''))
                estado["area_m2"] = area
                estado["etapa"] = "descripcion"
                return {'success': True, 'respuesta': f"""âœ… Ãrea: **{area:,.0f} mÂ²**

ğŸ“ **DescripciÃ³n tÃ©cnica detallada del proyecto:**
_Incluye: tipo de instalaciÃ³n, sistemas, equipos principales, etc._
_Ejemplo: Sistema elÃ©ctrico industrial completo con subestaciÃ³n de 1000 KVA, tableros de distribuciÃ³n, sistema de automatizaciÃ³n SCADA, iluminaciÃ³n LED, sistema de respaldo UPS_""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Ãrea invÃ¡lida. Por favor ingresa solo nÃºmeros.", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: DescripciÃ³n
        # ============================================
        elif etapa == "descripcion":
            estado["descripcion"] = mensaje
            estado["etapa"] = "normativa"
            return {'success': True, 'respuesta': f"""âœ… DescripciÃ³n guardada

ğŸ“‹ **Normativa aplicable:**
_Selecciona la normativa principal_

[CNE Suministro 2011] [NEC 2020] [IEC] [Otra]""", 'botones': [
                {'text': 'CNE Suministro 2011', 'value': 'CNE Suministro 2011'},
                {'text': 'NEC 2020', 'value': 'NEC 2020'},
                {'text': 'IEC', 'value': 'IEC'},
                {'text': 'Otra', 'value': 'OTRA'}
            ], 'estado': estado}
        
        # ============================================
        # ETAPA: Normativa
        # ============================================
        elif etapa == "normativa":
            if mensaje == "OTRA":
                estado["etapa"] = "normativa_otra"
                return {'success': True, 'respuesta': "ğŸ“‹ **Especifica la normativa:**", 'botones': None, 'estado': estado}
            else:
                estado["normativa"] = mensaje
                estado["etapa"] = "fecha_inicio"
                return {'success': True, 'respuesta': f"""âœ… Normativa: **{mensaje}**

ğŸ“… **Fecha de inicio estimada (DD/MM/YYYY):**
_Ejemplo: 01/02/2026_""", 'botones': None, 'estado': estado}
        
        elif etapa == "normativa_otra":
            estado["normativa"] = mensaje
            estado["etapa"] = "fecha_inicio"
            return {'success': True, 'respuesta': f"""âœ… Normativa: **{mensaje}**

ğŸ“… **Fecha de inicio estimada (DD/MM/YYYY):**""", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: Fecha inicio
        # ============================================
        elif etapa == "fecha_inicio":
            try:
                fecha = datetime.strptime(mensaje, "%d/%m/%Y")
                estado["fecha_inicio"] = mensaje
                estado["etapa"] = "kpi_spi"
                return {'success': True, 'respuesta': f"""âœ… Fecha inicio: **{mensaje}**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**KPIs DE GESTIÃ“N PMI**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Como proyecto complejo PMI, necesitamos definir los KPIs de gestiÃ³n.
Te ayudarÃ© con valores recomendados segÃºn mejores prÃ¡cticas.

ğŸ“Š **SPI (Schedule Performance Index)**
_Mide el desempeÃ±o del cronograma_

Valores:
â€¢ **1.0** = En tiempo (recomendado)
â€¢ > 1.0 = Adelantado
â€¢ < 1.0 = Retrasado

Rango vÃ¡lido: 0.8 - 1.2

**Â¿Valor de SPI?**
_Ejemplo: 1.0_""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Formato de fecha invÃ¡lido. Usa DD/MM/YYYY", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: KPI - SPI
        # ============================================
        elif etapa == "kpi_spi":
            try:
                spi = float(mensaje)
                if spi < 0.5 or spi > 1.5:
                    return {'success': False, 'respuesta': "âš ï¸ SPI fuera de rango razonable (0.5-1.5). Por favor verifica.", 'botones': None, 'estado': estado}
                estado["spi"] = spi
                estado["etapa"] = "kpi_cpi"
                return {'success': True, 'respuesta': f"""âœ… SPI: **{spi}**

ğŸ“Š **CPI (Cost Performance Index)**
_Mide el desempeÃ±o del costo_

Valores:
â€¢ **1.0** = En presupuesto (recomendado)
â€¢ > 1.0 = Bajo presupuesto
â€¢ < 1.0 = Sobre presupuesto

Rango vÃ¡lido: 0.8 - 1.2

**Â¿Valor de CPI?**
_Ejemplo: 1.05_""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Valor invÃ¡lido. Ingresa un nÃºmero decimal (ej: 1.0)", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: KPI - CPI
        # ============================================
        elif etapa == "kpi_cpi":
            try:
                cpi = float(mensaje)
                if cpi < 0.5 or cpi > 1.5:
                    return {'success': False, 'respuesta': "âš ï¸ CPI fuera de rango razonable (0.5-1.5). Por favor verifica.", 'botones': None, 'estado': estado}
                estado["cpi"] = cpi
                estado["etapa"] = "kpi_ev"
                
                presupuesto = estado.get("presupuesto", 100000)
                sugerencia_ev = int(presupuesto * 0.70 / 1000)
                
                return {'success': True, 'respuesta': f"""âœ… CPI: **{cpi}**

ğŸ“Š **EV (Earned Value)**
_Valor ganado del proyecto en miles_

Sugerencia: **${sugerencia_ev}K** (70% del presupuesto)

**Â¿Valor de EV en miles?**
_Ejemplo: {sugerencia_ev}_""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Valor invÃ¡lido. Ingresa un nÃºmero decimal (ej: 1.05)", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: KPI - EV
        # ============================================
        elif etapa == "kpi_ev":
            try:
                ev = int(mensaje)
                estado["ev_k"] = ev
                estado["etapa"] = "kpi_pv"
                
                presupuesto = estado.get("presupuesto", 100000)
                sugerencia_pv = int(presupuesto * 0.75 / 1000)
                
                return {'success': True, 'respuesta': f"""âœ… EV: **${ev}K**

ğŸ“Š **PV (Planned Value)**
_Valor planificado del proyecto en miles_

Sugerencia: **${sugerencia_pv}K** (75% del presupuesto)

**Â¿Valor de PV en miles?**
_Ejemplo: {sugerencia_pv}_""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Valor invÃ¡lido. Ingresa un nÃºmero entero.", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: KPI - PV
        # ============================================
        elif etapa == "kpi_pv":
            try:
                pv = int(mensaje)
                estado["pv_k"] = pv
                estado["etapa"] = "kpi_ac"
                
                presupuesto = estado.get("presupuesto", 100000)
                sugerencia_ac = int(presupuesto * 0.65 / 1000)
                
                return {'success': True, 'respuesta': f"""âœ… PV: **${pv}K**

ğŸ“Š **AC (Actual Cost)**
_Costo real del proyecto en miles_

Sugerencia: **${sugerencia_ac}K** (65% del presupuesto)

**Â¿Valor de AC en miles?**
_Ejemplo: {sugerencia_ac}_""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Valor invÃ¡lido. Ingresa un nÃºmero entero.", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: KPI - AC
        # ============================================
        elif etapa == "kpi_ac":
            try:
                ac = int(mensaje)
                estado["ac_k"] = ac
                estado["etapa"] = "alcance"
                
                return {'success': True, 'respuesta': f"""âœ… AC: **${ac}K**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… **KPIs PMI COMPLETADOS**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

SPI: {estado.get('spi')} | CPI: {estado.get('cpi')}
EV: ${estado.get('ev_k')}K | PV: ${estado.get('pv_k')}K | AC: ${ac}K

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**ALCANCE DEL PROYECTO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ **DescripciÃ³n detallada del alcance (WBS Level 1):**

Incluye todos los entregables principales del proyecto.

_Ejemplo:_
_â€¢ DiseÃ±o e ingenierÃ­a elÃ©ctrica completa_
_â€¢ Suministro de materiales certificados_
_â€¢ InstalaciÃ³n de sistema elÃ©ctrico_
_â€¢ Sistema de automatizaciÃ³n y control SCADA_
_â€¢ Pruebas FAT/SAT_
_â€¢ DocumentaciÃ³n tÃ©cnica as-built_
_â€¢ CapacitaciÃ³n al personal_
_â€¢ GarantÃ­a de 24 meses_

**Tu alcance:**""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Valor invÃ¡lido. Ingresa un nÃºmero entero.", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: Alcance
        # ============================================
        elif etapa == "alcance":
            estado["alcance"] = mensaje
            estado["etapa"] = "dias_ingenieria"
            
            # ğŸ¯ ENVIAR FORMULARIO DE ENTREGABLES
            return {
                'success': True, 
                'respuesta': """âœ… Alcance definido

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**ENTREGABLES DEL PROYECTO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“¦ **Selecciona los entregables necesarios:**""",
                'botones': None,
                'estado': estado,
                # âœ¨ FORMULARIO: Entregables
                'formulario': {
                    'tipo': 'entregables',
                    'tipoProyecto': estado.get('tipo_proyecto', 'industrial'),
                    'presupuesto': estado.get('presupuesto', 0),
                    'area': estado.get('area_m2', 0)
                }
            }
        
        # ============================================
        # ETAPA: DÃ­as IngenierÃ­a
        # ============================================
        elif etapa == "dias_ingenieria":
            try:
                dias = int(mensaje)
                if dias < 5 or dias > 90:
                    return {'success': False, 'respuesta': "âš ï¸ DuraciÃ³n fuera de rango razonable (5-90 dÃ­as).", 'botones': None, 'estado': estado}
                estado["dias_ingenieria"] = dias
                estado["etapa"] = "dias_ejecucion"
                return {'success': True, 'respuesta': f"""âœ… IngenierÃ­a y DiseÃ±o: **{dias} dÃ­as**

â±ï¸ **DÃ­as para EjecuciÃ³n:**
_Sugerencia: 40-60 dÃ­as_""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Valor invÃ¡lido. Ingresa solo el nÃºmero de dÃ­as.", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: DÃ­as EjecuciÃ³n
        # ============================================
        elif etapa == "dias_ejecucion":
            try:
                dias = int(mensaje)
                if dias < 10 or dias > 180:
                    return {'success': False, 'respuesta': "âš ï¸ DuraciÃ³n fuera de rango razonable (10-180 dÃ­as).", 'botones': None, 'estado': estado}
                estado["dias_ejecucion"] = dias
                
                # Calcular duraciÃ³n total
                duracion_total = 10 + 3 + estado.get("dias_ingenieria", 25) + dias + 8 + 5
                estado["duracion_total"] = duracion_total
                
                estado["etapa"] = "riesgo1_desc"
                return {'success': True, 'respuesta': f"""âœ… EjecuciÃ³n: **{dias} dÃ­as**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… **CRONOGRAMA COMPLETADO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

DuraciÃ³n total: **{duracion_total} dÃ­as**

1. Inicio y PlanificaciÃ³n: 10 dÃ­as
2. GestiÃ³n Stakeholders: 3 dÃ­as
3. IngenierÃ­a y DiseÃ±o: {estado.get('dias_ingenieria')} dÃ­as
4. EjecuciÃ³n: {dias} dÃ­as
5. Pruebas y Puesta en Marcha: 8 dÃ­as
6. Cierre: 5 dÃ­as

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**REGISTRO DE RIESGOS (TOP 5)**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Identificaremos los 5 riesgos principales del proyecto.

Para cada riesgo necesito:
â€¢ DescripciÃ³n
â€¢ Probabilidad (Alta/Media/Baja)
â€¢ Impacto (Alto/Medio/Bajo)
â€¢ Plan de MitigaciÃ³n

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**RIESGO 1 de 5**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ **DescripciÃ³n del riesgo:**
_Ejemplo: Retrasos en entrega de equipos importados_""", 'botones': None, 'estado': estado}
            except:
                return {'success': False, 'respuesta': "âŒ Valor invÃ¡lido. Ingresa solo el nÃºmero de dÃ­as.", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: Riesgos (Loop de 5)
        # ============================================
        elif etapa.startswith("riesgo"):
            return self._procesar_riesgo(mensaje, estado)
        
        # ============================================
        # ETAPA: Recursos Humanos
        # ============================================
        elif etapa == "recursos_humanos":
            recursos = [r.strip() for r in mensaje.split(',') if r.strip()]
            estado["recursos_humanos"] = recursos
            estado["etapa"] = "materiales"
            return {'success': True, 'respuesta': f"""âœ… Equipo: **{len(recursos)} roles** definidos

ğŸ”§ **Materiales principales (separados por coma):**
_Ejemplo: Tableros elÃ©ctricos, Cables THW, Protecciones termomagnÃ©ticas, Sistema SCADA, UPS_""", 'botones': None, 'estado': estado}
        
        # ============================================
        # ETAPA: Materiales
        # ============================================
        elif etapa == "materiales":
            materiales = [m.strip() for m in mensaje.split(',') if m.strip()]
            estado["materiales"] = materiales
            return self._generar_proyecto(estado)
        
        return {'success': False, 'respuesta': "âŒ Etapa no reconocida", 'botones': None, 'estado': estado}
    
    def _procesar_riesgo(self, mensaje: str, estado: Dict) -> Dict:
        """Procesa el loop de 5 riesgos"""
        etapa = estado.get("etapa")
        
        # Inicializar lista de riesgos si no existe
        if "riesgos" not in estado:
            estado["riesgos"] = []
        
        # Extraer nÃºmero de riesgo y campo
        partes = etapa.split("_")
        num_riesgo = int(partes[0].replace("riesgo", ""))
        campo = "_".join(partes[1:])
        
        # Inicializar riesgo temporal si no existe
        if "riesgo_temp" not in estado:
            estado["riesgo_temp"] = {}
        
        if campo == "desc":
            estado["riesgo_temp"]["descripcion"] = mensaje
            estado["etapa"] = f"riesgo{num_riesgo}_prob"
            return {'success': True, 'respuesta': f"""âœ… DescripciÃ³n: **{mensaje}**

ğŸ“Š **Probabilidad del riesgo:**

[Alta] [Media] [Baja]""", 'botones': [
                {'text': 'Alta', 'value': 'Alta'},
                {'text': 'Media', 'value': 'Media'},
                {'text': 'Baja', 'value': 'Baja'}
            ], 'estado': estado}
        
        elif campo == "prob":
            estado["riesgo_temp"]["probabilidad"] = mensaje
            estado["etapa"] = f"riesgo{num_riesgo}_imp"
            return {'success': True, 'respuesta': f"""âœ… Probabilidad: **{mensaje}**

ğŸ’¥ **Impacto del riesgo:**

[Alto] [Medio] [Bajo]""", 'botones': [
                {'text': 'Alto', 'value': 'Alto'},
                {'text': 'Medio', 'value': 'Medio'},
                {'text': 'Bajo', 'value': 'Bajo'}
            ], 'estado': estado}
        
        elif campo == "imp":
            estado["riesgo_temp"]["impacto"] = mensaje
            estado["etapa"] = f"riesgo{num_riesgo}_mit"
            
            # Calcular severidad
            prob = estado["riesgo_temp"]["probabilidad"]
            imp = mensaje
            severidad = self._calcular_severidad(prob, imp)
            estado["riesgo_temp"]["severidad"] = severidad
            
            return {'success': True, 'respuesta': f"""âœ… Impacto: **{mensaje}**
âœ… Severidad calculada: **{severidad}**

ğŸ›¡ï¸ **Plan de MitigaciÃ³n:**
_Describe las acciones para reducir o eliminar el riesgo_
_Ejemplo: Compra anticipada de equipos crÃ­ticos con proveedores alternativos_""", 'botones': None, 'estado': estado}
        
        elif campo == "mit":
            estado["riesgo_temp"]["mitigacion"] = mensaje
            estado["riesgo_temp"]["id"] = f"R{num_riesgo:02d}"
            
            # Guardar riesgo completo
            estado["riesgos"].append(estado["riesgo_temp"].copy())
            estado.pop("riesgo_temp")
            
            # Verificar si hay mÃ¡s riesgos
            if num_riesgo < 5:
                estado["etapa"] = f"riesgo{num_riesgo + 1}_desc"
                return {'success': True, 'respuesta': f"""âœ… Plan de mitigaciÃ³n guardado

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… **RIESGO {num_riesgo} COMPLETADO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**RIESGO {num_riesgo + 1} de 5**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“ **DescripciÃ³n del riesgo:**""", 'botones': None, 'estado': estado}
            else:
                # Todos los riesgos completados
                estado["etapa"] = "recursos_humanos"
                
                # ğŸ¯ ENVIAR FORMULARIO en lugar de texto libre
                return {
                    'success': True, 
                    'respuesta': """âœ… Plan de mitigaciÃ³n guardado

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… **TODOS LOS RIESGOS COMPLETADOS**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Ahora necesito informaciÃ³n sobre los recursos del proyecto.

ğŸ‘¥ **Selecciona el equipo profesional necesario:**""",
                    'botones': None,
                    'estado': estado,
                    # âœ¨ NUEVO: Enviar formulario interactivo
                    'formulario': {
                        'tipo': 'profesionales',
                        'tipoProyecto': estado.get('tipo_proyecto', 'industrial'),
                        'presupuesto': estado.get('presupuesto', 0),
                        'area': estado.get('area_m2', 0)
                    }
                }
        
        return {'success': False, 'respuesta': "âŒ Campo de riesgo no reconocido", 'botones': None, 'estado': estado}
    
    def _calcular_severidad(self, probabilidad: str, impacto: str) -> str:
        """Calcula la severidad del riesgo segÃºn probabilidad e impacto"""
        matriz = {
            ('Alta', 'Alto'): 'Alta',
            ('Alta', 'Medio'): 'Alta',
            ('Alta', 'Bajo'): 'Media',
            ('Media', 'Alto'): 'Alta',
            ('Media', 'Medio'): 'Media',
            ('Media', 'Bajo'): 'Baja',
            ('Baja', 'Alto'): 'Media',
            ('Baja', 'Medio'): 'Baja',
            ('Baja', 'Bajo'): 'Baja'
        }
        return matriz.get((probabilidad, impacto), 'Media')
    
    def _generar_proyecto(self, estado: Dict) -> Dict:
        """Genera el proyecto completo con todos los datos"""
        
        # Datos del cliente y proyecto
        cliente = estado.get("cliente_nombre", "Cliente")
        nombre = estado.get("proyecto_nombre", "Proyecto ElÃ©ctrico")
        ubicacion = estado.get("ubicacion", "Lima, PerÃº")
        area = estado.get("area_m2", 1000)
        descripcion = estado.get("descripcion", "Proyecto elÃ©ctrico")
        normativa = estado.get("normativa", "CNE Suministro 2011")
        presupuesto = estado.get("presupuesto", 100000)
        moneda = estado.get("moneda", "USD")
        
        # Fechas y duraciÃ³n
        fecha_inicio = datetime.strptime(estado.get("fecha_inicio", "01/01/2026"), "%d/%m/%Y")
        duracion_total = estado.get("duracion_total", 100)
        fecha_fin = fecha_inicio + timedelta(days=duracion_total)
        
        # CÃ³digo proyecto
        codigo = f"PROY-PMI-{fecha_inicio.year}-{self.contador:03d}"
        self.contador += 1
        
        # KPIs
        spi = estado.get("spi", 1.0)
        cpi = estado.get("cpi", 1.0)
        ev_k = estado.get("ev_k", 70)
        pv_k = estado.get("pv_k", 75)
        ac_k = estado.get("ac_k", 65)
        
        # Alcance
        alcance = estado.get("alcance", "Alcance del proyecto")
        
        # Cronograma
        dias_ingenieria = estado.get("dias_ingenieria", 25)
        dias_ejecucion = estado.get("dias_ejecucion", 50)
        
        # Stakeholders (siempre los 3 bÃ¡sicos)
        stakeholders = [
            {
                "nombre": cliente,
                "rol": "Cliente / Patrocinador Principal",
                "poder": "Alto",
                "interes": "Alto"
            },
            {
                "nombre": "Jefe de Proyecto",
                "rol": "Project Manager / Responsable de EjecuciÃ³n",
                "poder": "Alto",
                "interes": "Alto"
            },
            {
                "nombre": "Equipo TÃ©cnico",
                "rol": "Ingenieros y TÃ©cnicos Instaladores",
                "poder": "Medio",
                "interes": "Alto"
            }
        ]
        
        # Riesgos
        riesgos = estado.get("riesgos", [])
        
        # Recursos
        recursos_humanos = estado.get("recursos_humanos", ["Project Manager", "Ing. Residente", "TÃ©cnicos"])
        materiales = estado.get("materiales", ["Tableros elÃ©ctricos", "Cables", "Protecciones"])
        
        # Generar datos completos
        datos_generados = {
            "codigo": codigo,
            "nombre": nombre,
            "cliente": {
                "nombre": estado.get("cliente_nombre", cliente),
                "ruc": estado.get("cliente_ruc"),
                "direccion": estado.get("cliente_direccion"),
                "telefono": estado.get("cliente_telefono"),
                "email": estado.get("cliente_email")
            },
            "ubicacion": ubicacion,
            "area_m2": area,
            "descripcion": descripcion,
            "normativa": normativa,
            "cronograma": {
                "fecha_inicio": fecha_inicio.strftime("%d/%m/%Y"),
                "fecha_fin": fecha_fin.strftime("%d/%m/%Y"),
                "duracion_total": duracion_total
            },
            "presupuesto": presupuesto,
            "moneda": moneda,
            "kpis": {
                "spi": spi,
                "cpi": cpi,
                "ev_k": ev_k,
                "pv_k": pv_k,
                "ac_k": ac_k
            },
            "alcance": alcance,
            "fases_gantt": [
                {"nombre": "Inicio y PlanificaciÃ³n", "duracion": 10},
                {"nombre": "GestiÃ³n Stakeholders", "duracion": 3},
                {"nombre": "IngenierÃ­a y DiseÃ±o", "duracion": dias_ingenieria},
                {"nombre": "EjecuciÃ³n", "duracion": dias_ejecucion},
                {"nombre": "Pruebas y Puesta en Marcha", "duracion": 8},
                {"nombre": "Cierre", "duracion": 5}
            ],
            "stakeholders": stakeholders,
            "riesgos": riesgos,
            "recursos": {
                "humanos": recursos_humanos,
                "materiales": materiales
            }
        }
        
        simbolo = {'PEN': 'S/', 'USD': '$', 'EUR': 'â‚¬', 'GBP': 'Â£'}.get(moneda, '$')
        
        return {
            'success': True,
            'respuesta': f"""ğŸ‰ **PROJECT CHARTER GENERADO**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
**RESUMEN DEL PROYECTO**
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“‹ **CÃ³digo:** {codigo}
ğŸ¢ **Cliente:** {cliente}
ğŸ“ **UbicaciÃ³n:** {ubicacion}
ğŸ“ **Ãrea:** {area:,.0f} mÂ²

**CRONOGRAMA:**
â€¢ Inicio: {fecha_inicio.strftime("%d/%m/%Y")}
â€¢ Fin: {fecha_fin.strftime("%d/%m/%Y")}
â€¢ DuraciÃ³n: {duracion_total} dÃ­as

**PRESUPUESTO:**
â€¢ Total: {simbolo} {presupuesto:,.2f}

**KPIs PMI:**
â€¢ SPI: {spi} | CPI: {cpi}
â€¢ EV: ${ev_k}K | PV: ${pv_k}K | AC: ${ac_k}K

**RIESGOS:** {len(riesgos)} identificados
**STAKEHOLDERS:** {len(stakeholders)} registrados

âœ… **Documento listo para generar**

Haz clic en "Finalizar" para ver la vista previa y generar el PROJECT CHARTER en Word/PDF.""",
            'botones': None,
            'estado': estado,
            'datos_generados': datos_generados
        }
